name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
          cache: true
          cache-dependency-path: |
            Directory.Packages.props
            **/*.csproj
      - run: dotnet tool restore
      - run: dotnet csharpier check .

  build:
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
          cache: true
          cache-dependency-path: |
            Directory.Packages.props
            **/*.csproj
      - run: dotnet tool restore
      - uses: actions/cache@v4
        with:
          path: Resonite
          key: RML-4.0.0
      - run: |
          mkdir -p Resonite/Libraries Resonite/rml_libs
          if [ ! -f Resonite/Libraries/ResoniteModLoader.dll ]; then
            curl -L -o Resonite/Libraries/ResoniteModLoader.dll https://github.com/resonite-modding-group/ResoniteModLoader/releases/download/4.0.0/ResoniteModLoader.dll
          fi
          if [ ! -f Resonite/rml_libs/0Harmony.dll ]; then
            curl -L -o Resonite/rml_libs/0Harmony.dll https://github.com/resonite-modding-group/ResoniteModLoader/releases/download/4.0.0/0Harmony.dll
          fi
      - run: dotnet restore
      - run: dotnet build --configuration Release --no-restore
      - run: dotnet test --configuration Release --no-build
